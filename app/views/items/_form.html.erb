<% tags ||= @tags %>
<div class="page-wrapper min-h-screen py-12">
  <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-bold text-center text-gray-800 mb-6">アイテム登録</h2>

    <%= form_with(model: item, local: true, html: { multipart: true }) do |f| %>
      <% if item.errors.any? %>
        <div class="mb-4 p-4 bg-red-100 border border-red-300 text-red-700 rounded">
          <h3 class="font-bold mb-2"><%= pluralize(item.errors.count, "件のエラー") %>があります:</h3>
          <ul class="list-disc pl-5">
            <% item.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%# --- 各フィールド --- %>
      <div class="space-y-4 text-sm text-gray-700">
        <%# 画像 %>
        <div>
          <%= f.label :image, '画像（※名前または画像どちらか必須）', class: "block font-medium mb-1" %>
           
          <% if @item.image.attached? %>
  <div class="mb-4">
    <p class="text-sm text-gray-600">現在の画像：</p>
    <% begin %>
      <%= image_tag @item.image.variant(resize_to_limit: [400, 400]).processed,
        class: "mx-auto w-[220px] h-auto max-h-[250px] rounded border object-contain" %>
    <% rescue => e %>
      <p class="text-red-500 text-sm text-center">画像が表示できません（形式が非対応かもしれません）</p>
    <% end %>
  </div>
<% end %>

          <%= f.file_field :image, accept: 'image/*', id: 'image_input', class: "block w-full border border-gray-300 rounded p-2 bg-gray-50" %>
          <p class="text-xs text-gray-500 mt-2 text-center">
            ※ iPhoneで撮影したHEIC形式の画像は、パソコンからは表示できないことがあります。<br>
            表示させたい場合は画像を編集アプリ等で「.jpg」または「.png」形式に変換してください。
          </p>
         <div id="preview_container" class="mt-4 relative w-fit mx-auto">
  <button type="button" id="remove_image_btn"
          class="hidden absolute top-0 right-0 bg-white text-red-600 rounded-full w-6 h-6 text-center shadow hover:bg-red-100 z-10">
    ×
  </button>

  <img id="preview_image" src="#" alt="プレビュー"
       class="hidden w-[220px] h-auto max-h-[250px] rounded border object-contain" />
</div>

<% if @item.persisted? %>
<div class="mt-4 flex justify-center gap-4">
  <%= button_to '背景を透過する', remove_white_bg_item_path(@item),
      method: :post,
      data: { turbo_confirm: "白背景を透過します。続行しますか？" },
      class: 'bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-4 rounded' %>
</div>
<% end %>

        <%# アイテム名 %>
        <div>
          <%= f.label :name, 'アイテム名（※アイテム名または画像どちらか必須）', class: "block font-medium mb-1" %>
          <%= f.text_field :name, class: "w-full border border-gray-300 rounded p-2" %>
        </div>

        <%# ブランド %>
        <div>
          <%= f.label :brand, 'ブランド', class: "block font-medium mb-1" %>
          <%= f.text_field :brand, class: "w-full border border-gray-300 rounded p-2" %>
        </div>

        <%# カテゴリ %>
        <div>
          <%= f.label :category, 'カテゴリ', class: "block font-medium mb-1" %>
          <%= f.select :category, [['-- 選択なし --', '']] + Item::CATEGORIES.map { |c| [c, c] }, { selected: @item.category }, class: "w-full border border-gray-300 rounded p-2 bg-white" %>
        </div>

        <%# 値段 %>
        <div>
          <%= f.label :price, '値段', class: "block font-medium mb-1" %>
          <%= f.text_field :price, placeholder: '例：1500 (半角数字・カンマなし)', class: "w-full border border-gray-300 rounded p-2" %>
        </div>

        <%# カラー、キーワード①② %>
        <div>
          <%= f.label :color, 'カラー', class: "block font-medium mb-1" %>
          <%= f.select :color, [['-- 選択なし --', '']] + Item::COLORS.map { |c| [c, c] }, { selected: @item.color }, class: "w-full border border-gray-300 rounded p-2 bg-white" %>
        </div>

        <div>
          <%= f.label :keyword1, 'キーワード①', class: "block font-medium mb-1" %>
          <%= f.text_field :keyword1, class: "w-full border border-gray-300 rounded p-2" %>
        </div>

        <div>
          <%= f.label :keyword2, 'キーワード②', class: "block font-medium mb-1" %>
          <%= f.text_field :keyword2, class: "w-full border border-gray-300 rounded p-2" %>
        </div>

        <div>
          <%= f.label :description, '説明', class: "block font-medium mb-1" %>
          <%= f.text_area :description, class: "w-full border border-gray-300 rounded p-2", rows: 3 %>
        </div>
      </div>

<div>
  <%= f.label :tag_ids, 'タグ（複数選択可）', class: "block font-medium mb-1" %>
  <div class="flex flex-wrap gap-3">
    <%= f.collection_check_boxes :tag_ids, @tags, :id, :name do |b| %>
      <label class="flex items-center space-x-2 bg-pink-50 hover:bg-pink-100 border border-pink-200 rounded-full px-3 py-1 cursor-pointer transition">
        <%= b.check_box(class: "w-4 h-4 accent-pink-500") %>
        <span class="text-gray-800 text-sm"><%= b.text %></span>
      </label>
    <% end %>
  </div>
</div>

<%# シェアクローゼット公開フラグ %>
        <div>
          <%= f.label :public, 'シェアクローゼットに公開する', class: "inline-flex items-center" %>
          <%= f.check_box :public, class: "ml-2" %>
        </div>

      <%# --- ボタン --- %>
      <div class="mt-6 text-center">
        <%= f.submit "登録する", class: "px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition" %>
      </div>
    <% end %>
  </div>
</div>
